#!/usr/bin/env ruby

require_relative '../utils/diggit'

def verify_version(program, expected, actual)
  unless expected == actual
    fail "[diggit] Requires version #{expected} for `#{program}` but got #{actual}"
  end
end

diggit = Diggit.new

puts(diggit: diggit.info)

verify_version('ruby', diggit.ruby_version, RUBY_VERSION)
verify_version('node', diggit.node_version, `node --version`.chomp.gsub(/^v/, ''))

Dir.chdir(diggit.path) do
  print "\nRunning node tests..."
  node_passed = system %(
  ./node_modules/.bin/mocha \
    --harmony \
    --harmony_destructuring \
    --harmony_spread_arrays \
    ./client/specHelper.js \
    $(find client \
        -path client/bower_components -prune -o \
        -name '*.spec.js' \
        -print0 | xargs -0)
  )

  puts "Running ruby tests...\n\n"
  ruby_passed = system %(
    find . \
      -path ./node_modules -prune -o \
      -name '*.rb' \
      -print0 | xargs -0 bundle exec rspec --color
  )

  process.exit(255) unless node_passed && ruby_passed
end
